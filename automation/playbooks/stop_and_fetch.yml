---
- name: Stop Capture and Harvest Data
  hosts: workers
  become: true
  serial: 1
  tasks:
    - name: 0. 確保 rsync 已安裝
      apt:
        name: rsync
        state: present
      ignore_errors: yes

    # [修改] 加上 || true，如果行程已經死了也不要報錯 (紅字)
    - name: 1. 停止 tcpdump (SIGTERM)
      shell: "pkill tcpdump || true"
      
    - name: 2. 等待 IO 寫入緩衝
      pause:
        seconds: 2

    - name: 3. 修改 pcap 檔案擁有人 (Root -> User)
      file:
        path: "/tmp/traffic_data/{{ inventory_hostname }}.pcap"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
      ignore_errors: yes

    # [修改] 使用絕對路徑
    - name: 4. 傳輸 pcap 檔案 (Rsync Pull)
      synchronize:
        mode: pull
        src: "/tmp/traffic_data/{{ inventory_hostname }}.pcap"
        # [修正] 使用 lookup('env', 'HOME') 抓取本機使用者的家目錄
        # 這樣會解析為 /home/traffic_gen/Traffic-Project/data_lake/ 而不是 /root/...
        dest: "{{ lookup('env', 'HOME') }}/Traffic-Project/data_lake/"
        compress: no
      become: false
      register: sync_result
      ignore_errors: yes

    - name: 4.5. 顯示傳輸失敗警告
      debug:
        msg: "⚠️ 警告：{{ inventory_hostname }} 檔案傳輸失敗 (可能是檔案不存在)！"
      when: sync_result is failed

    - name: 5. 強制刪除遠端暫存檔
      file:
        path: "/tmp/traffic_data/{{ inventory_hostname }}.pcap"
        state: absent
      become: true