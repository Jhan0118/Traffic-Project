---
- name: Stop Capture and Harvest Data
  hosts: workers
  become: true
  serial: 1
  tasks:
    - name: 1. 停止 tcpdump (SIGTERM)
      shell: "pkill tcpdump"
      ignore_errors: yes

    - name: 2. 等待 IO 寫入緩衝
      pause:
        seconds: 2

    - name: 3. 傳輸 pcap 檔案回本機
      fetch:
        src: "/tmp/traffic_data/{{ inventory_hostname }}.pcap"
        # [修正] 請改成 ../data_lake/
        # 解析邏輯：
        # 執行點: ~/Traffic-Gen/automation/
        # ../    : ~/Traffic-Gen/
        # 結果   : ~/Traffic-Gen/data_lake/
        dest: "../data_lake/" 
        flat: yes
      register: fetch_result

    - name: 4. 刪除遠端暫存檔
      file:
        path: "/tmp/traffic_data/{{ inventory_hostname }}.pcap"
        state: absent
      when: fetch_result is succeeded