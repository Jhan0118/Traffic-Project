---
- name: 1. 基礎環境與映像檔準備 (所有節點)
  hosts: all
  become: true
  tasks:
    - name: 更新 apt 快取 (等待鎖釋放)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      register: apt_result
      until: apt_result is success
      retries: 10
      delay: 10

    - name: 安裝 Python Docker SDK
      apt:
        name: 
          - python3-docker
          - python3-pip
        state: present
      register: apt_install_result
      until: apt_install_result is success
      retries: 10
      delay: 10

    - name: 安裝 Docker
      shell: "curl -fsSL https://get.docker.com | sh"
      args:
        creates: /usr/bin/docker

    # [新增] 確保 Docker 服務已啟動並設定開機自啟
    - name: 確保 Docker 服務已啟動
      service:
        name: docker
        state: started
        enabled: yes

    - name: 設定 UFW 防火牆
      shell: |
        ufw allow 22/tcp
        ufw allow 2377/tcp
        ufw allow 7946/tcp
        ufw allow 7946/udp
        ufw allow 4789/udp
        ufw --force enable

    # [新增] 讓所有節點登入 (為了預先下載)
    - name: 登入 Docker Hub (所有節點)
      community.docker.docker_login:
        username: "{{ docker_hub_user }}"
        password: "{{ docker_hub_pass }}"
        registry_url: https://index.docker.io/v1/
      no_log: true

    # [新增] 預先下載 Image，這樣 Python 腳本啟動時就不用等下載
    - name: 預先下載 Traffic Bot Image (Pre-pull)
      community.docker.docker_image:
        name: jhancc0118/traffic-generation:v3
        source: pull
        force_source: yes
      register: image_pull
      retries: 3
      delay: 10
      until: image_pull is success

- name: 2. Manager 節點設定
  hosts: managers
  become: true
  tasks:
    - name: 初始化 Swarm Cluster
      community.docker.docker_swarm:
        state: present
        advertise_addr: "{{ ansible_host }}"
      register: swarm_info

    - name: 取得 Worker Join Token
      set_fact:
        worker_token: "{{ swarm_info.swarm_facts.JoinTokens.Worker }}"

    # (原本的登入步驟已移至上方，這裡移除以避免重複)

    - name: 建立專案目錄 /srv/traffic-bot
      file:
        path: /srv/traffic-bot
        state: directory
        mode: '0755'

    - name: 複製 sites.json
      copy:
        src: ../src/sites.json
        dest: /srv/traffic-bot/sites.json
        mode: '0644'

    - name: 複製 docker-stack.yml
      copy:
        src: ./docker-stack.yml
        dest: /srv/traffic-bot/docker-stack.yml
        mode: '0644'

- name: 3. Worker 節點設定
  hosts: workers
  become: true
  tasks:
    - name: 加入 Swarm Cluster
      community.docker.docker_swarm:
        state: join
        join_token: "{{ hostvars[groups['managers'][0]]['worker_token'] }}"
        remote_addrs: [ "{{ hostvars[groups['managers'][0]]['ansible_host'] }}:2377" ]

- name: 4. 啟動服務 (Standby Mode)
  hosts: managers
  become: true
  tasks:
    - name: 部署 Swarm Stack
      shell: |
        docker stack deploy --with-registry-auth -c docker-stack.yml my-simulation
      args:
        chdir: /srv/traffic-bot