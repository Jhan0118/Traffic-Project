---
- name: 1. 基礎環境設定 (所有節點)
  hosts: all
  become: true
  tasks:
    - name: 更新 apt 快取 (等待鎖釋放)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      register: apt_result
      until: apt_result is success
      retries: 10
      delay: 10

    - name: 安裝 Python Docker SDK
      apt:
        name: 
          - python3-docker
          - python3-pip
        state: present

    - name: 安裝 Docker
      shell: "curl -fsSL https://get.docker.com | sh"
      args:
        creates: /usr/bin/docker

    - name: 設定 UFW 防火牆
      shell: |
        ufw allow 22/tcp
        ufw allow 2377/tcp
        ufw allow 7946/tcp
        ufw allow 7946/udp
        ufw allow 4789/udp
        ufw --force enable

- name: 2. Manager 節點設定
  hosts: managers
  become: true
  tasks:
    - name: 初始化 Swarm Cluster
      community.docker.docker_swarm:
        state: present
        advertise_addr: "{{ ansible_host }}"
      register: swarm_info

    - name: 取得 Worker Join Token
      set_fact:
        worker_token: "{{ swarm_info.swarm_facts.JoinTokens.Worker }}"

    - name: 登入 Docker Hub
      community.docker.docker_login:
        username: "{{ docker_hub_user }}"
        password: "{{ docker_hub_pass }}"
        registry_url: https://index.docker.io/v1/
      no_log: true

    # [關鍵步驟 1] 建立統一的專案目錄
    # 這解決了 "找不到 /home/manager" 的問題
    - name: 建立專案目錄 /srv/traffic-bot
      file:
        path: /srv/traffic-bot
        state: directory
        mode: '0755'

    # [關鍵步驟 2] 複製 sites.json 到該目錄
    # Swarm 的 Configs 會從這裡讀取檔案
    - name: 複製 sites.json 到 /srv/traffic-bot
      copy:
        src: ../src/sites.json
        dest: /srv/traffic-bot/sites.json
        mode: '0644'

    # [關鍵步驟 3] 複製 docker-stack.yml 到該目錄
    - name: 複製 docker-stack.yml 到 /srv/traffic-bot
      copy:
        src: ./docker-stack.yml
        dest: /srv/traffic-bot/docker-stack.yml
        mode: '0644'

    # [關鍵步驟 4] 在該目錄執行部署指令
    - name: 部署 Swarm Stack
      shell: |
        docker stack deploy --with-registry-auth -c docker-stack.yml my-simulation
      args:
        chdir: /srv/traffic-bot

- name: 3. Worker 節點設定
  hosts: workers
  become: true
  tasks:
    - name: 加入 Swarm Cluster
      community.docker.docker_swarm:
        state: join
        join_token: "{{ hostvars[groups['managers'][0]]['worker_token'] }}"
        remote_addrs: [ "{{ hostvars[groups['managers'][0]]['ansible_host'] }}:2377" ]