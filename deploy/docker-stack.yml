version: '3.8'

services:
  traffic-bot:
    # [Image] 使用 V3 版本
    image: jhancc0118/traffic-generation:v3
    environment:
      - HEADLESS_MODE=true
    
    # [關鍵 1] 掛載設定檔 (V3 必備)
    configs:
      - source: sites_config
        target: /traffic_data/sites.json
    
    # [關鍵 2] 使用記憶體當暫存區 (保護硬碟)
    tmpfs:
      - /tmp

    deploy:
      # [修改] 預設為 0，讓自動化腳本來控制何時啟動
      replicas: 0
      
      resources:
        limits:
          cpus: '1.0'        # 允許突發到 1 核
          memory: 1200M      # 上限 1.2G
        reservations:
          cpus: '0.55'
          memory: 600M       # 預留資源確保穩定
          
      placement:
        constraints:
          - node.role == worker
        # [關鍵新增] 強制平均分配策略 (Spread Strategy)
        # 這告訴 Swarm：請根據節點 ID 將任務平均分散，不要集中在某一台
        preferences:
          - spread: node.id
      
      # [關鍵 3] 優化更新策略
      update_config:
        parallelism: 5
        delay: 10s
        order: stop-first
      
      restart_policy:
        condition: on-failure
        max_attempts: 3

# [關鍵 4] 定義設定檔來源
configs:
  sites_config:
    file: /srv/traffic-bot/sites.json