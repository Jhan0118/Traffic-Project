version: '3.8'

services:
  traffic-bot:
    image: jhancc0118/traffic-generation:v3
    environment:
      - HEADLESS_MODE=true
      # [新增] 靶機的主機名稱設定
      - TARGET_MAIL_HOST=mail-server
      - TARGET_FTP_HOST=ftp-server
      - TARGET_SSH_HOST=ssh-target
      - TARGET_SMB_HOST=smb-server
    
    configs:
      - source: sites_config
        target: /traffic_data/sites.json
    
    tmpfs:
      - /tmp

    deploy:
      replicas: 0
      
      resources:
        limits:
          cpus: '1.0'
          memory: 1200M
        reservations:
          cpus: '0.25'
          memory: 300M
          
      placement:
        constraints:
          - node.role == worker
        preferences:
          - spread: node.id
      
      update_config:
        parallelism: 5
        delay: 10s
        order: stop-first
      
      restart_policy:
        condition: on-failure
        max_attempts: 3

  # ==========================================
  # [新增] 靶機服務 (跑在 Manager)
  # ==========================================

  # 1. 郵件伺服器
  mail-server:
    image: mailhog/mailhog
    ports:
      - "8025:8025"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  # 2. FTP 伺服器
  ftp-server:
    image: fauria/vsftpd
    environment:
      - FTP_USER=testuser
      - FTP_PASS=testpass
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  # 3. SSH 靶機
  ssh-target:
    image: linuxserver/openssh-server
    ports:
      - "2222:2222"
    environment:
      - PUID=1000
      - PGID=1000
      - PASSWORD_ACCESS=true
      - USER_PASSWORD=password
      - USER_NAME=linuxuser
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  # 4. SMB 伺服器 (Windows 網芳)
  smb-server:
    image: dperson/samba
    environment:
      - USER=testuser;testpass
      - SHARE=public;/mount/public;yes;no;no;all;none;;
      - WORKGROUP=WORKGROUP
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

configs:
  sites_config:
    file: /srv/traffic-bot/sites.json